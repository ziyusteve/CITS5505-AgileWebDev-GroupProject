{% extends "layout.html" %}

{% block title %} - Data Visualization{% endblock %}

{% block head_content %}
<style>
    .chart-container {
        height: 400px;
    }
</style>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item active">Visualize: {{ dataset.title }}</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i>{{ dataset.title }}</h4>
                    {% if is_owner %}
                    <a href="{{ url_for('share_data') }}" class="btn btn-sm btn-light">
                        <i class="fas fa-share-alt me-1"></i>Share
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <p class="mb-1 fw-bold">Dataset Owner:</p>
                            <p>{{ dataset.owner.username }}</p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-1 fw-bold">Date Uploaded:</p>
                            <p>{{ dataset.date_uploaded.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1 fw-bold">Description:</p>
                            <p>{{ dataset.description or 'No description provided' }}</p>
                        </div>
                    </div>
                    <hr>
                    
                    <!-- Visualization Controls -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label class="form-label">Visualization Type:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-chart-type="bar">
                                    <i class="fas fa-chart-bar me-1"></i>Bar
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-chart-type="line">
                                    <i class="fas fa-chart-line me-1"></i>Line
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-chart-type="pie">
                                    <i class="fas fa-chart-pie me-1"></i>Pie
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-chart-type="scatter">
                                    <i class="fas fa-braille me-1"></i>Scatter
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button id="downloadBtn" class="btn btn-outline-success">
                                <i class="fas fa-download me-1"></i>Download Analysis
                            </button>
                        </div>
                    </div>                    <!-- Visualization Area -->
                    <div class="row">
                        <div class="col">
                            <div id="visualization" class="chart-container border rounded p-3 bg-light">
                                <div class="alert alert-info mb-3">
                                    <p><i class="fas fa-info-circle me-2"></i><strong>数据可视化指南</strong></p>
                                    <ol class="mb-0">
                                        <li>选择合适的 X/Y 轴列展示您的数据</li>
                                        <li>使用不同的图表类型来探索数据关系</li>
                                        <li>在下方查看数据统计摘要和见解</li>
                                    </ol>
                                </div>
                                <div id="chart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics and Analysis -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>统计摘要</h5>
                </div>
                <div class="card-body">
                    <div id="statistics" class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>数值</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>样本数量</td><td id="stat-count">-</td></tr>
                                <tr><td>均值</td><td id="stat-mean">-</td></tr>
                                <tr><td>中位数</td><td id="stat-median">-</td></tr>
                                <tr><td>标准差</td><td id="stat-std">-</td></tr>
                                <tr><td>最小值</td><td id="stat-min">-</td></tr>
                                <tr><td>最大值</td><td id="stat-max">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Insights</h5>
                </div>
                <div class="card-body">
                    <div id="insights" class="px-2">
                        <div class="alert alert-secondary" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="insight-text">When data is loaded, automated insights will appear here.</span>
                        </div>
                        
                        <ul class="list-group list-group-flush" id="insights-list">
                            <!-- Insights will be dynamically added here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Preview -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Data Preview</h5>
                </div>
                <div class="card-body">
                    <div id="data-preview" class="table-responsive">
                        <!-- Table will be dynamically populated -->
                        <p class="text-center text-muted">Loading data preview...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Store dataset ID and metadata
    const datasetId = {{ dataset.id }};
    const metadata = {{ metadata|tojson }};
    
    // Initialize chart data
    let chartData = null;
    let chartOptions = {
        x_column: null,
        y_column: null,
        chart_type: 'bar'
    };
    
    // Color palette for charts
    const colorPalette = [
        'rgba(75, 192, 192, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)',
        'rgba(255, 99, 132, 0.7)',
        'rgba(255, 206, 86, 0.7)'
    ];

    // Initialize the chart
    document.addEventListener('DOMContentLoaded', function() {
        // Create placeholder until data is loaded
        const chartContainer = document.getElementById('chart');
        Plotly.newPlot('chart', [{
            type: 'bar',
            x: [],
            y: []
        }], {
            margin: { t: 10, b: 30, l: 40, r: 10 },
            responsive: true
        });
        
        // Load the dataset analysis
        fetchDatasetAnalysis();        // Add column selection controls
        const controlsArea = document.querySelector('.chart-container');
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'mb-3 row';
        controlsDiv.innerHTML = `
            <div class="col-md-5 mb-2">
                <label for="x-column" class="form-label">X-Axis Column:</label>
                <select id="x-column" class="form-select form-select-sm"></select>
            </div>
            <div class="col-md-5 mb-2">
                <label for="y-column" class="form-label">Y-Axis Column:</label>
                <select id="y-column" class="form-select form-select-sm"></select>
            </div>
            <div class="col-md-2 mb-2 d-flex align-items-end">
                <button id="updateChartBtn" class="btn btn-sm btn-primary w-100">Update Chart</button>
            </div>
        `;
        controlsArea.insertBefore(controlsDiv, document.getElementById('chart'));
        
        // Chart type buttons
        document.querySelectorAll('[data-chart-type]').forEach(button => {
            button.addEventListener('click', (e) => {
                // Update active button
                document.querySelectorAll('[data-chart-type]').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.closest('button').classList.add('active');

                // Get the chart type
                chartOptions.chart_type = e.target.closest('button').getAttribute('data-chart-type');
                
                // Update chart
                fetchVisualizationData();
            });
        });
        
        // Column selection change
        document.getElementById('updateChartBtn').addEventListener('click', function() {
            const xColumnSelect = document.getElementById('x-column');
            const yColumnSelect = document.getElementById('y-column');
            
            chartOptions.x_column = xColumnSelect.value;
            chartOptions.y_column = yColumnSelect.value;
            
            fetchVisualizationData();
        });
        
        // Function to fetch dataset analysis
        async function fetchDatasetAnalysis() {
            try {
                const response = await fetch(`/api/dataset/${datasetId}/analyze`);
                
                if (!response.ok) {
                    throw new Error('Failed to load dataset analysis');
                }
                
                const analysisData = await response.json();
                
                // Update UI with analysis data
                updateColumnSelectors(analysisData);
                updateStatistics(analysisData);
                updateInsights(analysisData);
                updateDataPreview(analysisData);
                
                // Set default columns and fetch visualization
                if (analysisData.column_names && analysisData.column_names.length > 0) {
                    const xColumnSelect = document.getElementById('x-column');
                    const yColumnSelect = document.getElementById('y-column');
                    
                    chartOptions.x_column = xColumnSelect.value;
                    chartOptions.y_column = yColumnSelect.value;
                    
                    fetchVisualizationData();
                }
                
            } catch (error) {
                console.error('Error loading dataset analysis:', error);
                document.getElementById('visualization').innerHTML = 
                    `<div class="alert alert-danger">Error loading dataset: ${error.message}</div>`;
            }
        }
        
        // Function to update column selectors
        function updateColumnSelectors(analysisData) {
            const xColumnSelect = document.getElementById('x-column');
            const yColumnSelect = document.getElementById('y-column');
            
            // Clear existing options
            xColumnSelect.innerHTML = '';
            yColumnSelect.innerHTML = '';
            
            // Add options for all columns
            analysisData.column_names.forEach(column => {
                xColumnSelect.innerHTML += `<option value="${column}">${column}</option>`;
            });
            
            // For Y-axis, prioritize numeric columns
            if (analysisData.numeric_columns && analysisData.numeric_columns.length > 0) {
                analysisData.numeric_columns.forEach(column => {
                    yColumnSelect.innerHTML += `<option value="${column}">${column}</option>`;
                });
                
                // Add non-numeric columns as well
                analysisData.categorical_columns.forEach(column => {
                    yColumnSelect.innerHTML += `<option value="${column}">${column}</option>`;
                });
                
                // Default to first numeric column for y-axis
                yColumnSelect.value = analysisData.numeric_columns[0];
            } else {
                // If no numeric columns, just add all columns
                analysisData.column_names.forEach(column => {
                    yColumnSelect.innerHTML += `<option value="${column}">${column}</option>`;
                });
                
                // Default to second column for y-axis if available
                if (analysisData.column_names.length > 1) {
                    yColumnSelect.value = analysisData.column_names[1];
                }
            }
        }
        
        // Function to fetch visualization data
        async function fetchVisualizationData() {
            try {
                // Show loading indicator
                document.getElementById('chart').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                
                const url = `/api/dataset/${datasetId}/visualize?chart_type=${chartOptions.chart_type}&x_column=${encodeURIComponent(chartOptions.x_column)}&y_column=${encodeURIComponent(chartOptions.y_column)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to load visualization data');
                }
                
                const visualData = await response.json();
                updateChart(visualData, chartOptions.chart_type);
                
            } catch (error) {
                console.error('Error loading visualization data:', error);
                document.getElementById('chart').innerHTML = 
                    `<div class="alert alert-danger">Error loading visualization: ${error.message}</div>`;
            }
        }
        
        // Function to update chart based on data
        function updateChart(data, chartType) {
            let chartData = [];
            
            if (chartType === 'pie') {
                chartData = [{
                    values: data.values || [],
                    labels: data.labels || [],
                    type: 'pie',
                    textinfo: 'label+percent',
                    marker: {
                        colors: colorPalette
                    }
                }];
            } else {
                chartData = [{
                    x: data.x || [],
                    y: data.y || [],
                    type: chartType,
                    marker: {
                        color: chartType === 'bar' ? colorPalette[0] : colorPalette[1]
                    },
                    line: {
                        color: colorPalette[1],
                        width: 2
                    }
                }];
            }
            
            Plotly.react('chart', chartData, {
                margin: { t: 20, b: 40, l: 50, r: 20 },
                responsive: true,
                height: 350
            });
        }
        
        // Function to update statistics section with real data
        function updateStatistics(analysisData) {
            // Check if we have statistics for at least one numeric column
            if (analysisData.statistics && analysisData.numeric_columns && analysisData.numeric_columns.length > 0) {
                const firstNumCol = analysisData.numeric_columns[0];
                const stats = analysisData.statistics[firstNumCol];
                
                // Update the statistics in the UI
                document.getElementById('stat-count').textContent = stats['count'].toFixed(0);
                document.getElementById('stat-mean').textContent = stats['mean'].toFixed(2);
                document.getElementById('stat-median').textContent = stats['50%'].toFixed(2);
                document.getElementById('stat-std').textContent = stats['std'].toFixed(2);
                document.getElementById('stat-min').textContent = stats['min'].toFixed(2);
                document.getElementById('stat-max').textContent = stats['max'].toFixed(2);
                
                // Add column name to the statistics table heading
                const statsTable = document.querySelector('#statistics table');
                const headerRow = statsTable.querySelector('thead tr');
                const headerCells = headerRow.querySelectorAll('th');
                
                if (headerCells.length > 0) {
                    headerCells[0].textContent = 'Metric';
                    if (headerCells.length > 1) {
                        headerCells[1].textContent = `Value (${firstNumCol})`;
                    }
                }
            } else {
                document.getElementById('statistics').innerHTML = 
                    '<div class="alert alert-secondary">No numeric data available for statistical analysis.</div>';
            }
        }
        
        // Function to update insights with real data
        function updateInsights(analysisData) {
            const insightsList = document.getElementById('insights-list');
            insightsList.innerHTML = '';
            
            if (analysisData.insights && analysisData.insights.length > 0) {
                document.getElementById('insight-text').textContent = 'Here are some insights based on the analysis:';
                
                analysisData.insights.forEach(insight => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i> ${insight}`;
                    insightsList.appendChild(li);
                });
            } else {
                document.getElementById('insight-text').textContent = 'No automated insights available for this dataset.';
                
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<i class="fas fa-info-circle text-info me-2"></i> Try changing the visualization to explore patterns in your data.`;
                insightsList.appendChild(li);
            }
        }
        
        // Function to update data preview with real data
        function updateDataPreview(analysisData) {
            const dataPreview = document.getElementById('data-preview');
            
            if (analysisData.preview && analysisData.preview.length > 0) {
                const columns = analysisData.column_names;
                
                let tableHTML = `<table class="table table-striped table-sm"><thead><tr>`;
                columns.forEach(col => {
                    tableHTML += `<th>${col}</th>`;
                });
                tableHTML += `</tr></thead><tbody>`;
                
                analysisData.preview.forEach(row => {
                    tableHTML += `<tr>`;
                    columns.forEach(col => {
                        tableHTML += `<td>${row[col] !== null ? row[col] : ''}</td>`;
                    });
                    tableHTML += `</tr>`;
                });
                
                tableHTML += `</tbody></table>`;
                dataPreview.innerHTML = tableHTML;
            } else {
                dataPreview.innerHTML = '<div class="alert alert-secondary">No preview data available.</div>';
            }
        }
        
        // Download button event
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            try {
                const response = await fetch(`/api/dataset/${datasetId}/analyze`);
                if (!response.ok) throw new Error('Failed to load dataset analysis');
                
                const data = await response.json();
                const jsonData = JSON.stringify(data, null, 2);
                
                // Create a blob and download link
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'dataset_analysis.json';
                
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error preparing download:', error);
                alert('Failed to prepare download. Please try again.');
            }
        });
    });
</script>
{% endblock %}